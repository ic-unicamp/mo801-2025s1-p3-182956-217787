#include <string.h>
#include <stdio.h>
#include <stddef.h>
#include <stdarg.h>
#include <generated/csr.h>
#include <irq.h>
#include <libbase/uart.h>
#include <libbase/console.h>

#include "drivers/dot_product_accel_driver.h"

uint32_t start_ticks;
uint32_t elapsed_ticks;

void start_stopwatch(void);
void stop_stopwatch(void);
void print_elapsed_time(uint32_t ticks, const char* benchmark_name);
int predict(double *x);
int predict_hw(double *x);
int benchmark(void);
double dot(size_t size, double*x, double*w);
double dot_hw(size_t size, double*x, double *w);

void start_stopwatch(void) {
    // Disable timer
    timer0_en_write(0);
    
    // Set timer to count down from maximum value
    timer0_reload_write(0xffffffff);
    timer0_load_write(0xffffffff);
    
    // Enable timer
    timer0_en_write(1);
    
    // Update and read initial value
    timer0_update_value_write(1);
    start_ticks = timer0_value_read();
}

void stop_stopwatch(void) {
    uint32_t end_ticks;
    
    // Update and read final value
    timer0_update_value_write(1);
    end_ticks = timer0_value_read();
    
    // Calculate elapsed ticks (timer counts down)
    elapsed_ticks = start_ticks - end_ticks;
}

// Print elapsed time without using floats
void print_elapsed_time(uint32_t ticks, const char* benchmark_name) {
    // Convert ticks to microseconds first, then to milliseconds
    uint32_t microseconds = ticks / (CONFIG_CLOCK_FREQUENCY / 1000000);
    uint32_t milliseconds = microseconds / 1000;
    uint32_t seconds = milliseconds / 1000;
    uint32_t minutes = seconds / 60;
    uint32_t rem_seconds = seconds % 60;
    uint32_t rem_milliseconds = milliseconds % 1000;
    uint32_t MHz = CONFIG_CLOCK_FREQUENCY / 1000000;
    
    printf("=== %s Results ===\n", benchmark_name);
    printf("Raw ticks: %lu\n", ticks);
    printf("Elapsed time: %02d:%02d.%03d (%lu milliseconds)\n", 
           (int)minutes, (int)rem_seconds, (int)rem_milliseconds, (unsigned long)milliseconds);
    printf("CPU: %s @ %luMHz\n", CONFIG_CPU_HUMAN_NAME, (unsigned long)MHz);
    printf("Clock frequency: %lu Hz\n", (unsigned long)CONFIG_CLOCK_FREQUENCY);
    printf("\n");
}

double weight0[] = {0.0  , -0.006306189867  , -0.018296405192  , 0.084762387657  , 0.037514608659  , -0.051827392383  , -0.143796229328  , -0.023446105406  , -3.2133093e-05  , -0.080529834312  , 0.023390448999  , 0.184212651911  , -0.010320456068  , 0.072863841516  , -0.059281337856  , -0.021769122851  , -0.001251733292  , 0.013868849804  , 0.102467729537  , -0.043624086804  , -0.353900620692  , 0.155743766271  , 0.038795888364  , -0.005737312035  , -0.000624039357  , 0.131726915392  , 0.136302836076  , -0.08997267866  , -0.406394638739  , 0.060227226978  , 0.063342860909  , -0.00013615104  , 0.0  , 0.162439295397  , 0.060810137216  , -0.121815351484  , -0.363172136704  , 0.043422565911  , 0.04160266406  , 0.0  , -0.000303288049  , -0.06605360491  , 0.267869729277  , -0.196610056344  , -0.166875624935  , 0.085284015202  , 0.020921229986  , -0.000154931572  , -0.001034925372  , -0.13447296015  , 0.13825672337  , -0.112161066663  , 0.176811826372  , 0.000697000741  , -0.019396157146  , -0.009092016418  , -3.894054e-06  , -0.006510015231  , -0.087336515807  , 0.214062831214  , -0.027565326841  , -0.051194685875  , -0.025325848559  , -0.015531571251 };
double weight1[] = { 0.0  , 0.008783193837  , -0.160586863907  , 0.154398289688  , -0.694184845863  , 0.421365803903  , -0.02149083798  , -0.016027088721  , -0.000245628839  , -0.35904841929  , -0.308148232872  , -0.339946564308  , 0.309633457424  , -0.100598279759  , -0.292168631664  , -0.030028557197  , 0.093681411672  , 0.27626129863  , -0.045680066994  , 0.594634796719  , 0.129058416823  , -0.163455618102  , -0.003644133491  , -0.001374256106  , 0.022494246032  , -0.113822753125  , -0.021878371104  , 0.053474294801  , 0.258318409047  , 0.086066697272  , -0.078694770254  , -1.8964265e-05  , 0.0  , -0.137738005723  , 0.133749282102  , -0.140955106561  , 0.12313792143  , 0.153905353512  , -0.094831771753  , 0.0  , -0.000100235992  , -0.143063260192  , 0.105142027089  , 0.301112617866  , -0.044304969473  , -0.154614279895  , -0.53235643211  , -0.000781887217  , -0.000515509427  , -0.22016769135  , -0.121765828963  , 0.147897552242  , 0.228578150624  , -0.05771206848  , -0.195241637959  , 0.202628459619  , -0.000155224647  , 0.020709648523  , -0.193720117934  , -0.029653642169  , 0.127843257562  , 0.170388563138  , 0.108785512014  , 0.187751930395 };
double weight2[] = { 0.0  , 0.03117926457  , 0.090063595112  , -0.121523298559  , 0.103857728821  , -0.025481806057  , 0.025225799816  , -0.00105091496  , -0.029474179298  , 0.136898707169  , 0.065393021874  , -0.209350392057  , 0.31990178489  , 0.053038698795  , 0.061790186454  , -0.001110209082  , -0.014660537914  , -0.028280042538  , -0.068800217834  , -0.21891438844  , 0.238286033316  , -0.036487643325  , 0.170151891385  , -0.000252814461  , -1.2868845e-05  , -0.118665568759  , -0.513986429625  , -0.377911064511  , -0.141054376143  , -0.115960126181  , 0.048012087624  , -1.0912968e-05  , 0.0  , -0.105952537673  , -0.381723734714  , -0.109965439628  , -0.081538305285  , -0.268078921275  , -0.20055819366  , 0.0  , -5.4565388e-05  , 0.104510388044  , 0.110706365324  , 0.372817091373  , -0.275303645174  , -0.272895604379  , -0.117903149001  , -7.8988463e-05  , 0.00145728685  , 0.061919634699  , 0.017682885421  , 0.421136636901  , 0.327406678269  , 0.358918398305  , 0.14299321849  , 0.015807137234  , 0.000496682027  , 0.028963812622  , 0.17079134533  , 0.035372648511  , 0.083848729655  , 0.289505085505  , 0.367972673329  , 0.222696942119 };
double weight3[] = { 0.0  , 0.159195616115  , -0.080342311814  , 0.09634732791  , 0.496718617327  , 0.092426533078  , -0.024772643225  , 0.003073659395  , -0.003561880955  , 0.084272233599  , 0.21229925593  , 0.059905655007  , 0.109308690632  , 0.14310493395  , 0.132032522014  , 0.002501065398  , -0.001164427119  , 0.05686342298  , -0.337140894795  , -0.419474667967  , 0.169354236199  , -0.308939062765  , 0.001102408118  , -0.000529771919  , -7.284626e-06  , -0.296579768216  , -0.369672712566  , -0.129038498102  , 0.241316207155  , -0.188067017453  , -0.277569336772  , -1.0909562e-05  , 0.0  , -0.073713815341  , -0.143891374447  , 0.050550070345  , 0.119658280328  , -0.171315115898  , 0.002510802424  , 0.0  , -5.45307e-05  , 0.061291894587  , -0.442205021445  , -0.469226908655  , 0.127444469819  , 0.321841060743  , 0.226560520327  , -0.000176393074  , -4.6352143e-05  , -0.040887797384  , 0.12075775367  , -0.13287507589  , -0.069995897648  , 0.108804086616  , 0.321541083019  , -0.07844033311  , -4.542961e-06  , 0.138055038923  , 0.271895207627  , -0.016969475727  , 0.007860444602  , -0.041273824224  , 0.106493158018  , -0.19840377936 };
double weight4[] = { 0.0  , -0.020272268128  , -0.119064182495  , -0.292830642709  , -0.245525393468  , -0.408143789861  , -0.157308933458  , 0.06853390909  , -3.1108195e-05  , 0.033161933171  , -0.091707772911  , -0.173582356273  , -0.39735852411  , -0.092633567512  , -0.130482300017  , 0.06570001604  , -0.006931380541  , 0.26751239689  , 0.104311298394  , 0.188989036548  , -0.011399452884  , 0.164288420083  , -0.025416248343  , 0.046832519469  , 0.020987859698  , 0.063307388806  , 0.433667950095  , 0.061810815837  , 0.046603838547  , 0.030589119358  , 0.420946435837  , 0.001058104931  , 0.0  , 0.233518725981  , 0.248998383836  , -0.173218987529  , 0.293349883136  , 0.17714397651  , 0.250254473614  , 0.0  , 0.000932503581  , 0.476208482058  , -0.021583044372  , 0.560996968643  , 0.390106320118  , 0.117664874323  , 0.111035439612  , -0.0002136213  , 0.001659934488  , 0.241966104026  , -0.183006295491  , 0.002366834064  , -0.026522719816  , -0.295580783542  , -0.281220883535  , -0.005541921828  , -5.205304e-06  , -0.081493226166  , -0.069482048766  , -0.249523741854  , -0.063769846143  , -0.203322594583  , -0.022651251551  , -0.001983626624 };
double weight5[] = { 0.0  , 0.108348523825  , 0.503242289635  , 0.000626732472  , -0.011039256786  , 0.205266757507  , 0.35070566351  , -0.049266711034  , -4.40608e-06  , -0.103728610105  , 0.062848102739  , 0.211124656943  , -0.101444841008  , -0.017294244337  , -0.017067451608  , -0.019097823147  , -0.000667783416  , -0.045768153818  , 0.105269851299  , 0.011833302371  , -0.344518809193  , -0.348604078274  , -0.498331951146  , -0.004740211171  , -0.000329331553  , 0.355358829026  , 0.271929220374  , 0.063072777242  , 0.240635894323  , -0.168920693532  , -0.203624092741  , -1.4975007e-05  , 0.0  , -0.014855929571  , 0.102615541717  , -0.251340990749  , -0.155238600987  , 0.066782887148  , 0.338994372472  , 0.0  , -5.4610774e-05  , -0.084332512783  , -0.272337908263  , -0.253970580416  , -0.029047220114  , 0.138059084394  , 0.118724463317  , -0.000186505544  , -4.411368e-05  , 0.04251207549  , -0.050791152824  , -0.167926582238  , 0.160810293054  , -0.074811622575  , -0.114286075933  , -0.002846023995  , -3.745538e-06  , 0.123442839436  , 0.215613943052  , 0.145885718312  , -0.085473589398  , -0.047767804497  , -0.405753484876  , -0.009266501594 };
double weight6[] = { 0.0  , -0.003120662717  , -0.223903967715  , -0.116239227956  , -0.012254649906  , -0.029044420407  , -0.039467448842  , -0.000656800923  , -8.5735014e-05  , -0.086130180495  , -0.13898629292  , -0.017658494871  , -0.292910310291  , -0.008466383771  , 0.006038235176  , -0.000719048469  , -0.002440180658  , -0.16764376028  , 0.124486747955  , 0.031073413127  , -0.224817577011  , -0.331184818912  , -0.108788333892  , -0.000403051244  , -0.001205012108  , 0.038364236048  , 0.01597477444  , 0.051649933734  , -0.157950698112  , -0.030241171672  , -0.207215035449  , -5.7041985e-05  , 0.0  , 0.204158777453  , 0.178458416167  , 0.247029819178  , 0.040539656862  , -0.059362604859  , 0.059829525748  , 0.0  , -0.000199098268  , -0.172187725933  , 0.480596214848  , 0.209599301723  , 0.136141866866  , -0.033140480281  , 0.27722233875  , 0.002298949435  , -0.000414590615  , -0.10152405026  , -0.021420932061  , 0.142373594105  , -0.09252911426  , 0.299236251367  , 0.105103618543  , -0.126914230355  , -3.709915e-06  , -0.006463576136  , -0.139920646565  , -0.117523997194  , -0.018736906746  , 0.179243904017  , -0.011593955426  , -0.096677704796 };
double weight7[] = { 0.0  , 0.053993271739  , 0.063310143842  , 0.131335481552  , 0.103668191437  , -0.025971184172  , 0.191755616523  , 0.101023791854  , -2.9124002e-05  , 0.134632015151  , 0.096758647235  , 0.049311270684  , 0.385756042127  , -0.146880783646  , 0.049371496818  , 0.051820633172  , -1.8745434e-05  , -0.279908862887  , -0.244287745893  , -0.081054993354  , 0.081857722417  , 0.148587168358  , 0.240419924028  , 0.005234630712  , -8.393108e-06  , -0.205250039913  , -0.027386367846  , -0.322955152613  , 0.050183783179  , 0.147157640016  , 0.220427176041  , -0.000737210133  , 0.0  , 0.215706211254  , -0.022284678435  , -0.002298306945  , 0.127222526985  , 0.251925435087  , 0.258607050457  , 0.0  , -5.463705e-05  , -0.034078468031  , 0.030762004166  , 0.155026383757  , 0.084441375529  , -0.038948497991  , 0.055339707168  , -0.000152703044  , -5.2851536e-05  , -0.019671636647  , -0.079547935949  , 0.172179740485  , -0.226963550036  , -0.330369785542  , -0.092690398977  , -0.001075491496  , -6.703688e-06  , 0.024187695647  , 0.029801552654  , -0.103406612582  , -0.331336828187  , -0.278414345162  , -0.09080174704  , -0.002167935942 };
double weight8[] = { 0.0  , -0.164555957687  , 0.085327944519  , -0.295959516501  , 0.147576786591  , -0.087037809744  , -0.234342665425  , -0.014179266107  , 0.033526393782  , 0.075438470416  , -0.009416574181  , 0.100543432163  , -0.170237125763  , 0.1203742318  , 0.104565782088  , -0.007185474232  , -0.065990272354  , -0.069295889894  , 0.241345548338  , -0.108874232433  , 0.102776821594  , 0.2171549661  , 0.122196864164  , -0.000710852509  , -0.04102214708  , 0.046985236711  , -0.180413734439  , 0.357063834063  , -0.085397401203  , -0.016970211107  , -0.002250035564  , -2.1743178e-05  , 0.0  , -0.007370756646  , -0.088790180107  , 0.362112119613  , -0.007217685497  , -0.23823268677  , -0.551637845511  , 0.0  , -5.6999958e-05  , -0.150125365255  , 0.237740207749  , 0.070759583427  , 0.146392863786  , 0.012931787091  , 0.197887558085  , -0.000397967757  , -0.000964368007  , 0.172341682734  , 0.124281153353  , -0.244130865204  , -0.275991052864  , 0.150673382571  , 0.116190359257  , -0.033487077645  , -0.000309735356  , -0.10729289169  , -0.268489814155  , 0.038900706819  , 0.196418159089  , -0.003550114428  , -0.018745400579  , -0.062004225397 };
double weight9[] = { 0.0  , -0.167244791686  , -0.139750241985  , 0.359082466446  , 0.073668213188  , -0.091552691865  , 0.05349167841  , -0.068004473188  , -6.2198308e-05  , 0.165033684696  , 0.087569396107  , 0.135440140801  , -0.152328717833  , -0.023508447035  , 0.145201498595  , -0.040111479633  , -0.000556350944  , -0.023609258886  , 0.018027749993  , 0.045411820234  , 0.213303229431  , 0.502896900567  , 0.063513690812  , -0.038318880737  , -0.000273029055  , 0.09857552403  , 0.255462834595  , 0.332805738209  , -0.046261018055  , 0.19611853632  , 0.016624710371  , -5.0196793e-05  , 0.0  , -0.476191965131  , -0.087941793334  , 0.139902173759  , -0.096741540268  , 0.043809110633  , -0.10477107785  , 0.0  , -5.4537402e-05  , 0.007830172416  , -0.496690574372  , -0.750504401375  , -0.368995436422  , -0.176181959206  , -0.357431676133  , -0.000155951463  , -4.4510559e-05  , -0.002015361159  , 0.055553629475  , -0.228860767803  , -0.201604613695  , -0.159854859462  , 0.017006874242  , 0.038961497992  , -3.920564e-06  , -0.133599325929  , 0.070847094562  , 0.082855564671  , 0.110911906407  , -0.013614183891  , -0.008379655329  , -0.02441352755 };

int predict(double *x) {
    double votes[10] = { 0.00502334499 ,-0.12206523117 ,0.003579543967 ,0.020737360972 ,0.078377187135 ,-0.032150862747 ,-0.005069195112 ,0.014919916777 ,0.090375756313 ,-0.053727821125  };

    votes[0] += dot(64, x, weight0);
    votes[1] += dot(64, x, weight1);
    votes[2] += dot(64, x, weight2);
    votes[3] += dot(64, x, weight3);
    votes[4] += dot(64, x, weight4);
    votes[5] += dot(64, x, weight5);
    votes[6] += dot(64, x, weight6);
    votes[7] += dot(64, x, weight7);
    votes[8] += dot(64, x, weight8);
    votes[9] += dot(64, x, weight9);
    // return argmax of votes
    uint8_t classIdx = 0;
    double maxVotes = votes[0];

    for (uint8_t i = 1; i < 10; i++) {
        if (votes[i] > maxVotes) {
            classIdx = i;
            maxVotes = votes[i];
        }
    }

    return classIdx;
}

double dot(size_t size, double *x, double *w) {
    double dot = 0.0;

    for (uint16_t i = 0; i < size; i++) {
        dot += x[i] * w[i];
    }

    return dot;
}

int predict_hw(double *x) {
    double votes[10] = { 0.00502334499 ,-0.12206523117 ,0.003579543967 ,0.020737360972 ,0.078377187135 ,-0.032150862747 ,-0.005069195112 ,0.014919916777 ,0.090375756313 ,-0.053727821125  };

    votes[0] += dot_hw(64, x, weight0);
    votes[1] += dot_hw(64, x, weight1);
    votes[2] += dot_hw(64, x, weight2);
    votes[3] += dot_hw(64, x, weight3);
    votes[4] += dot_hw(64, x, weight4);
    votes[5] += dot_hw(64, x, weight5);
    votes[6] += dot_hw(64, x, weight6);
    votes[7] += dot_hw(64, x, weight7);
    votes[8] += dot_hw(64, x, weight8);
    votes[9] += dot_hw(64, x, weight9);
    // return argmax of votes
    uint8_t classIdx = 0;
    double maxVotes = votes[0];

    for (uint8_t i = 1; i < 10; i++) {
        if (votes[i] > maxVotes) {
            classIdx = i;
            maxVotes = votes[i];
        }
    }

    return classIdx;
}

double dot_hw(size_t size, double*x, double *weights) { 
    return logistic_accel_dot_product(size, x, weights);
}

int benchmark(void) {
    puts("LiteX Benchmark with Hardware Accelerator Starting...\n");
    
    double input2[64] = {
        0.1, -0.2, 0.05, 0.0, 0.3, -0.1, 0.2, 0.1,
        -0.05, 0.06, -0.07, 0.08, 0.09, -0.1, 0.12, 0.13,
        0.14, -0.15, 0.16, 0.17, 0.18, 0.19, -0.2, 0.21,
        0.22, -0.23, 0.24, 0.25, -0.26, 0.27, 0.28, 0.29,
        0.3, -0.31, 0.32, 0.33, 0.34, -0.35, 0.36, 0.37,
        0.38, 0.39, -0.4, 0.41, 0.42, -0.43, 0.44, 0.45,
        0.46, 0.47, -0.48, 0.49, 0.5, -0.51, 0.52, 0.53,
        0.54, 0.55, -0.56, 0.57, 0.58, 0.59, -0.6, 0.61
    };
    
    volatile int p1 = 0;
    volatile int p2 = 0;
    int i;
    
    // First benchmark - floating point prediction (CPU)
    printf("Running CPU only benchmark...\n");
    start_stopwatch();
    

    for (i = 0; i < 100; i += 1) {
        p1 += predict(input2);
    }
    
    stop_stopwatch();
    print_elapsed_time(elapsed_ticks, "CPU only Benchmark");

#if LOGISTIC_ACCEL_AVAILABLE 
    // Second benchmark - integer prediction (CPU)
    printf("Running Hardware acceleration benchmark...\n");
    start_stopwatch();
    
    for (i = 0; i < 100; i += 1) {
        p2 += predict_hw(input2);
    }
    
    stop_stopwatch();
    print_elapsed_time(elapsed_ticks, "CPU Hardware acceleration Benchmark");
#endif    
    printf("=== Final Results ===\n");
    printf("CPU accumulated result: %d\n", p1);

#if LOGISTIC_ACCEL_AVAILABLE 
    printf("Hardware acceleration accumulated result: %d\n", p2);
#endif    

    printf("\nBenchmark completed!\n");
    return 0;
}


/*-----------------------------------------------------------------------*/
/* Uart                                                                  */
/*-----------------------------------------------------------------------*/

static char *readstr(void)
{
	char c[2];
	static char s[64];
	static int ptr = 0;

	if(readchar_nonblock()) {
		c[0] = getchar();
		c[1] = 0;
		switch(c[0]) {
			case 0x7f:
			case 0x08:
				if(ptr > 0) {
					ptr--;
					fputs("\x08 \x08", stdout);
				}
				break;
			case 0x07:
				break;
			case '\r':
			case '\n':
				s[ptr] = 0x00;
				fputs("\n", stdout);
				ptr = 0;
				return s;
			default:
				if(ptr >= (sizeof(s) - 1))
					break;
				fputs(c, stdout);
				s[ptr] = c[0];
				ptr++;
				break;
		}
	}

	return NULL;
}

static char *get_token(char **str)
{
	char *c, *d;

	c = (char *)strchr(*str, ' ');
	if(c == NULL) {
		d = *str;
		*str = *str+strlen(*str);
		return d;
	}
	*c = 0;
	d = *str;
	*str = c+1;
	return d;
}

static void prompt(void)
{
	printf("\e[92;1mBruno-luiz-app\e[0m> ");
}

/*-----------------------------------------------------------------------*/
/* Help                                                                  */
/*-----------------------------------------------------------------------*/

static void help(void)
{
	puts("\nLiteX minimal demo app built "__DATE__" "__TIME__"\n");
	puts("Available commands:");
	puts("help                              - Show this command");
	puts("reboot                            - Reboot CPU");
	puts("hello                             - Hello world");
    puts("benchmark                         - benchmark");
}


/*-----------------------------------------------------------------------*/
/* Commands                                                              */
/*-----------------------------------------------------------------------*/

static void reboot_cmd(void)
{
	ctrl_reset_write(1);
}


static void helloc_cmd(void)
{
	printf("Hello C demo...\n");
}


/*-----------------------------------------------------------------------*/
/* Console service / Main                                                */
/*-----------------------------------------------------------------------*/

static void console_service(void)
{
	char *str;
	char *token;

	str = readstr();
	if(str == NULL) return;
	token = get_token(&str);
	if(strcmp(token, "help") == 0)
    {
		help();
    } 
    else if(strcmp(token, "reboot") == 0)
    {
		reboot_cmd();
    } 
    else if(strcmp(token, "hello") == 0) 
    {
		helloc_cmd();
    } 
    else if(strcmp(token, "benchmark") == 0)
    {
        benchmark();
    }
	prompt();
}

int main(void)
{
#ifdef CONFIG_CPU_HAS_INTERRUPT
	irq_setmask(0);
	irq_setie(1);
#endif
	uart_init();

	help();
	prompt();

	while(1) {
		console_service();
	}

	return 0;
}
